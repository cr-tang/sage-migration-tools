<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VT Feeder Unboxing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a73e8;
            border-bottom: 3px solid #1a73e8;
            padding-bottom: 10px;
        }
        h2 {
            color: #202124;
            margin-top: 40px;
            padding: 10px 0;
            border-bottom: 2px solid #e8eaed;
        }
        h3 {
            color: #5f6368;
            margin-top: 25px;
        }
        h4 {
            color: #1a73e8;
            margin-top: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #dadce0;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background: #fafafa;
        }
        code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        .info-box {
            background: #e8f0fe;
            border-left: 4px solid #1a73e8;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 4px 4px 0;
        }
        .warning-box {
            background: #fef7e0;
            border-left: 4px solid #f9ab00;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 4px 4px 0;
        }
        .success-box {
            background: #e6f4ea;
            border-left: 4px solid #34a853;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 4px 4px 0;
        }
        .toc {
            background: #f8f9fa;
            padding: 20px 30px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .toc ul {
            list-style: none;
            padding-left: 0;
        }
        .toc li {
            padding: 5px 0;
        }
        .toc a {
            color: #1a73e8;
            text-decoration: none;
        }
        .toc a:hover {
            text-decoration: underline;
        }
        .diagram {
            background: #263238;
            color: #aed581;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
        }
        blockquote {
            border-left: 4px solid #dadce0;
            margin: 20px 0;
            padding: 10px 20px;
            color: #5f6368;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” VT Feeder Unboxing</h1>
        
        <blockquote>
            Complete technical documentation of the VirusTotal Feeder data pipeline and Sage integration.
        </blockquote>

        <div class="toc">
            <h3>ğŸ“‹ Table of Contents</h3>
            <ul>
                <li>1. <a href="#overview">Overview</a></li>
                <li>2. <a href="#architecture">Architecture Diagram</a></li>
                <li>3. <a href="#vt-feeder-suite">VT Feeder Suite</a></li>
                <li>4. <a href="#gcs-buckets">GCS Bucket Structure</a></li>
                <li>5. <a href="#broccoli">Broccoli Classification Service</a></li>
                <li>6. <a href="#sage-query">Sage Query Flow</a></li>
                <li>7. <a href="#mongodb">MongoDB Role</a></li>
                <li>8. <a href="#comparison">Data Type Comparison</a></li>
                <li>9. <a href="#takeaways">Key Takeaways</a></li>
            </ul>
        </div>

        <!-- Section 1: Overview -->
        <h2 id="overview">1. Overview</h2>
        
        <h3>What is VT Feeder?</h3>
        <p>VT Feeder is a data pipeline that:</p>
        <ol>
            <li><strong>Pulls</strong> full data stream from VirusTotal Feed API (every minute)</li>
            <li><strong>Stores</strong> raw reports in GCS buckets (indexed by hash)</li>
            <li><strong>Enriches</strong> reports with ML classification (Broccoli service)</li>
            <li><strong>Serves</strong> data to Sage for real-time queries</li>
        </ol>

        <h3>Why VT Feeder instead of Direct VT API?</h3>
        <table>
            <tr>
                <th>Aspect</th>
                <th>Direct VT API</th>
                <th>VT Feeder</th>
            </tr>
            <tr>
                <td><strong>Speed</strong></td>
                <td>~500ms per query</td>
                <td>~50ms per query</td>
            </tr>
            <tr>
                <td><strong>Rate Limit</strong></td>
                <td>Limited by VT API quota</td>
                <td>No limit (pre-fetched)</td>
            </tr>
            <tr>
                <td><strong>Cost</strong></td>
                <td>Per-query API cost</td>
                <td>Fixed storage cost</td>
            </tr>
            <tr>
                <td><strong>Data Coverage</strong></td>
                <td>On-demand only</td>
                <td>Full VT dataset</td>
            </tr>
            <tr>
                <td><strong>Classification</strong></td>
                <td>Raw results only</td>
                <td>ML-enhanced classification</td>
            </tr>
        </table>

        <!-- Section 2: Architecture -->
        <h2 id="architecture">2. Architecture Diagram</h2>
        
        <div class="diagram">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        VT Feeder Complete Architecture                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘  LAYER 1: Data Ingestion (VT Feeder Suite)                                    â•‘  â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£  â”‚
â”‚  â•‘                                                                               â•‘  â”‚
â”‚  â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â•‘  â”‚
â”‚  â•‘   â”‚  VirusTotal      â”‚                                                        â•‘  â”‚
â”‚  â•‘   â”‚  Feed API        â”‚  /vtapi/v2/file/feed?package={timestamp}              â•‘  â”‚
â”‚  â•‘   â”‚  (Premium)       â”‚  Returns: tar.bz2 with ALL files scanned that minute  â•‘  â”‚
â”‚  â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â•‘  â”‚
â”‚  â•‘            â”‚                                                                  â•‘  â”‚
â”‚  â•‘            â”‚ Every 60 seconds                                                 â•‘  â”‚
â”‚  â•‘            â–¼                                                                  â•‘  â”‚
â”‚  â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â•‘  â”‚
â”‚  â•‘   â”‚  VT Feeder Suite â”‚  VtFeederSchedulerService.java                        â•‘  â”‚
â”‚  â•‘   â”‚  (Scheduled Job) â”‚  VtFeederPackageHandlerService.java                   â•‘  â”‚
â”‚  â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â•‘  â”‚
â”‚  â•‘            â”‚                                                                  â•‘  â”‚
â”‚  â•‘            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â•‘  â”‚
â”‚  â•‘            â–¼                      â–¼                      â–¼                   â•‘  â”‚
â”‚  â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â•‘  â”‚
â”‚  â•‘   â”‚ vt-file-feeder â”‚    â”‚ vt-file-feeder â”‚    â”‚ Broccoli       â”‚            â•‘  â”‚
â”‚  â•‘   â”‚ /latest-reportsâ”‚    â”‚ -by-date/      â”‚    â”‚ Service        â”‚            â•‘  â”‚
â”‚  â•‘   â”‚ /{sha1}        â”‚    â”‚ {date}/{ts}    â”‚    â”‚ (ML Pipeline)  â”‚            â•‘  â”‚
â”‚  â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â•‘  â”‚
â”‚  â•‘         â”‚                                             â”‚                      â•‘  â”‚
â”‚  â•‘         â”‚ Real-time lookup                            â–¼                      â•‘  â”‚
â”‚  â•‘         â”‚ by hash                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â•‘  â”‚
â”‚  â•‘         â”‚                                    â”‚broccoli-enricher              â•‘  â”‚
â”‚  â•‘         â”‚                                    â”‚/latest-reports â”‚              â•‘  â”‚
â”‚  â•‘         â”‚                                    â”‚/{sha1}         â”‚              â•‘  â”‚
â”‚  â•‘         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚            â”‚                                             â”‚                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                               â”‚                                                    â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘  LAYER 2: Sage Service     â”‚                                                â•‘   â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â”‚
â”‚  â•‘                            â–¼                                                â•‘   â”‚
â”‚  â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘   â”‚
â”‚  â•‘   â”‚  VtFeederClient.java                                                 â”‚  â•‘   â”‚
â”‚  â•‘   â”‚                                                                      â”‚  â•‘   â”‚
â”‚  â•‘   â”‚  getReport(sha1)         â†’ reads vt-file-feeder/latest-reports/{sha1}â”‚  â•‘   â”‚
â”‚  â•‘   â”‚  getClassification(sha1) â†’ reads broccoli-enricher/latest-reports/   â”‚  â•‘   â”‚
â”‚  â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘   â”‚
â”‚  â•‘                            â”‚                                                â•‘   â”‚
â”‚  â•‘                            â–¼                                                â•‘   â”‚
â”‚  â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘   â”‚
â”‚  â•‘   â”‚  VirusTotalFileClassificationService.java                            â”‚  â•‘   â”‚
â”‚  â•‘   â”‚  - Combine raw report + ML classification                            â”‚  â•‘   â”‚
â”‚  â•‘   â”‚  - Calculate product classification                                   â”‚  â•‘   â”‚
â”‚  â•‘   â”‚  - Set TTL for cache expiration                                      â”‚  â•‘   â”‚
â”‚  â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘   â”‚
â”‚  â•‘                            â”‚                                                â•‘   â”‚
â”‚  â•‘                            â–¼                                                â•‘   â”‚
â”‚  â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘   â”‚
â”‚  â•‘   â”‚  MongoDB file_rep Collection (Cache)                                 â”‚  â•‘   â”‚
â”‚  â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>

        <!-- Section 3: VT Feeder Suite -->
        <h2 id="vt-feeder-suite">3. VT Feeder Suite</h2>
        
        <h3>Repository Location</h3>
        <pre>/Users/tangxin/work/vt-feeder-suite/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ vt-file-feeder/              # File reports feeder
â”‚   â”œâ”€â”€ vt-url-feeder/               # URL reports feeder
â”‚   â”œâ”€â”€ bq-vt-file-report-exporter/  # BigQuery exporter
â”‚   â””â”€â”€ bq-vt-url-report-exporter/   # URL to BigQuery
â””â”€â”€ common/
    â””â”€â”€ vt-feeder-spring-starter/    # Core feeder logic</pre>

        <h3>How VT Feeder Works</h3>
        
        <h4>1. Scheduled Data Pull</h4>
        <pre>// VtFeederSchedulerService.java
@Scheduled(fixedRateString = "${feederRate:60000}")  // Every 60 seconds
public void scheduleFixedDelayTask() {
    getFeeds();
}</pre>

        <h4>2. Download from VT Feed API</h4>
        <pre>// VtFeederPackageHandlerService.java
String feedPkgUrl = "https://www.virustotal.com/vtapi/v2/" + feedType + 
    "/feed?apikey=" + apiKey + "&package=" + timestamp;

// Downloads tar.bz2 package containing ALL files scanned in that minute</pre>

        <h4>3. Store to GCS</h4>
        <pre>// For File Feeder (should.store.latest.by.identifier=true)
private void storeFeedsLatestByIdentifier(List&lt;String&gt; allJsonReports) {
    for (String jsonReport : allJsonReports) {
        String identifier = jsonFileReportObject.get("sha1").getAsString();
        String blobPackageName = latestReportFolderName + "/" + identifier;
        gcsStorageConnector.store(jsonReport.getBytes(), blobPackageName, bucketName);
    }
}</pre>

        <h3>Configuration</h3>
        
        <div class="info-box">
            <strong>File Feeder Configuration</strong> (vt-file-feeder/application.properties)
        </div>
        <pre>bucket.name=vt-file-feeder
feeds.by.date.bucket.name=vt-file-feeder-by-date
latest.report.folder.name=latest-reports
should.store.latest.by.identifier=true   # â† Store by SHA1 hash
vt.feed.type=file</pre>

        <div class="warning-box">
            <strong>URL Feeder Configuration</strong> (vt-url-feeder/application.properties)
        </div>
        <pre>bucket.name=vt-url-feeder
feeds.by.date.bucket.name=vt-url-feeder-by-date
should.store.latest.by.identifier=false  # â† NOT stored by identifier!
vt.feed.type=url
gcp.bq.enable=true                       # â† URL goes to BigQuery instead</pre>

        <!-- Section 4: GCS Buckets -->
        <h2 id="gcs-buckets">4. GCS Bucket Structure</h2>
        
        <h3>Complete Bucket Map</h3>
        <div class="diagram">Google Cloud Storage
â”‚
â”œâ”€â”€ vt-file-feeder/                          # File reports (real-time lookup)
â”‚   â”œâ”€â”€ latest-reports/
â”‚   â”‚   â”œâ”€â”€ {sha1_hash_1}                    # JSON file, ~10KB
â”‚   â”‚   â”œâ”€â”€ {sha1_hash_2}
â”‚   â”‚   â””â”€â”€ ... (millions of files)
â”‚   â””â”€â”€ lastPackage                          # Timestamp of last processed package
â”‚
â”œâ”€â”€ vt-file-feeder-by-date/                  # File reports archive
â”‚   â”œâ”€â”€ 20251224/
â”‚   â”‚   â”œâ”€â”€ 20251224T0000                    # tar.bz2, ~50MB
â”‚   â”‚   â”œâ”€â”€ 20251224T0001
â”‚   â”‚   â””â”€â”€ ... (1440 packages per day)
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ broccoli-enricher/                       # ML classification results
â”‚   â””â”€â”€ latest-reports/
â”‚       â”œâ”€â”€ {sha1_hash_1}                    # JSON file, ~100 bytes
â”‚       â””â”€â”€ ...
â”‚
â””â”€â”€ vt-url-feeder-by-date/                   # URL reports (time-based only!)
    â”œâ”€â”€ 20251224/
    â”‚   â”œâ”€â”€ 20251224T0000                    # bzip2, ~2MB
    â”‚   â””â”€â”€ ...
    â””â”€â”€ ...</div>

        <h3>Bucket Comparison Table</h3>
        <table>
            <tr>
                <th>Bucket</th>
                <th>Path</th>
                <th>Index Key</th>
                <th>Query Method</th>
                <th>Size/File</th>
                <th>Purpose</th>
            </tr>
            <tr>
                <td><code>vt-file-feeder</code></td>
                <td>/latest-reports/{sha1}</td>
                <td>SHA1 hash</td>
                <td>âœ… Exact lookup</td>
                <td>~10 KB</td>
                <td>Real-time file queries</td>
            </tr>
            <tr>
                <td><code>vt-file-feeder-by-date</code></td>
                <td>/{date}/{timestamp}</td>
                <td>Timestamp</td>
                <td>âŒ Time-based only</td>
                <td>~50 MB</td>
                <td>Historical archive</td>
            </tr>
            <tr>
                <td><code>broccoli-enricher</code></td>
                <td>/latest-reports/{sha1}</td>
                <td>SHA1 hash</td>
                <td>âœ… Exact lookup</td>
                <td>~100 B</td>
                <td>ML classification cache</td>
            </tr>
            <tr>
                <td><code>vt-url-feeder-by-date</code></td>
                <td>/{date}/{timestamp}</td>
                <td>Timestamp</td>
                <td>âŒ Time-based only</td>
                <td>~2 MB</td>
                <td>URL archive (batch analysis)</td>
            </tr>
        </table>

        <!-- Section 5: Broccoli -->
        <h2 id="broccoli">5. Broccoli Classification Service</h2>
        
        <h3>What is Broccoli?</h3>
        <p><strong>Broccoli</strong> (Classifier V2) is Sage's <strong>ML-based classification service</strong>:</p>

        <div class="diagram">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Broccoli Service                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Input: Raw VT Report                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ {                                                                     â”‚  â”‚
â”‚  â”‚   "sha1": "abc123",                                                   â”‚  â”‚
â”‚  â”‚   "positives": 45,                                                    â”‚  â”‚
â”‚  â”‚   "scans": {                                                          â”‚  â”‚
â”‚  â”‚     "Kaspersky": {"detected": true, "result": "Trojan.Win32"},       â”‚  â”‚
â”‚  â”‚     "McAfee": {"detected": true, "result": "Artemis"},               â”‚  â”‚
â”‚  â”‚     "Symantec": {"detected": false, "result": null},                 â”‚  â”‚
â”‚  â”‚     ... (70+ engines with conflicting results!)                      â”‚  â”‚
â”‚  â”‚   }                                                                   â”‚  â”‚
â”‚  â”‚ }                                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â”‚ ML Model                                     â”‚
â”‚                              â”‚ - Analyzes all AV engine results             â”‚
â”‚                              â”‚ - Weighs engine quality scores               â”‚
â”‚                              â”‚ - Computes final classification              â”‚
â”‚                              â–¼                                              â”‚
â”‚  Output: Classification Result                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ {                                                                     â”‚  â”‚
â”‚  â”‚   "classification": "malware",  â† Final verdict                      â”‚  â”‚
â”‚  â”‚   "algoVersion": "2.3.1"        â† Model version                      â”‚  â”‚
â”‚  â”‚ }                                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>

        <h3>Why ML Classification?</h3>
        <table>
            <tr>
                <th>Problem</th>
                <th>Without ML</th>
                <th>With Broccoli ML</th>
            </tr>
            <tr>
                <td>Conflicting AV results</td>
                <td>Which engine to trust?</td>
                <td>Weighted score based on engine quality</td>
            </tr>
            <tr>
                <td>New malware variants</td>
                <td>May be missed</td>
                <td>Pattern recognition</td>
            </tr>
            <tr>
                <td>False positives</td>
                <td>Hard to filter</td>
                <td>Learned from historical data</td>
            </tr>
            <tr>
                <td>Classification types</td>
                <td>Simple majority voting</td>
                <td>Accurate type/subtype detection</td>
            </tr>
        </table>

        <!-- Section 6: Sage Query Flow -->
        <h2 id="sage-query">6. Sage Query Flow</h2>
        
        <h3>File Classification (Complete Flow)</h3>
        <div class="diagram">Client Request: classify("sha1:abc123")
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: Check MongoDB Cache                                                  â”‚
â”‚  lookupCache.getIfPresent("abc123")                                          â”‚
â”‚    â”œâ”€â”€ HIT + not expired â”€â”€â–º Return cached classification                    â”‚
â”‚    â””â”€â”€ MISS or expired â”€â”€â–º Continue to Step 2                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ MISS
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Query GCS (Parallel)                                                 â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  vt-file-feeder             â”‚    â”‚  broccoli-enricher          â”‚          â”‚
â”‚  â”‚  /latest-reports/abc123     â”‚    â”‚  /latest-reports/abc123     â”‚          â”‚
â”‚  â”‚                             â”‚    â”‚                             â”‚          â”‚
â”‚  â”‚  â†’ Raw VT Report            â”‚    â”‚  â†’ ML Classification        â”‚          â”‚
â”‚  â”‚  - sha1, md5, sha256        â”‚    â”‚  - "malware"                â”‚          â”‚
â”‚  â”‚  - positives: 45            â”‚    â”‚  - algoVersion: "2.3.1"     â”‚          â”‚
â”‚  â”‚  - scans: {...}             â”‚    â”‚                             â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                â”‚                                  â”‚                          â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                              â”‚                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Process & Combine                                                    â”‚
â”‚                                                                               â”‚
â”‚  if (broccoli classification exists && valid algo version):                   â”‚
â”‚      maliciousType = broccoli.classification                                  â”‚
â”‚  else:                                                                        â”‚
â”‚      sendToBroccoliQueue(vtReport)  // Async                                 â”‚
â”‚      maliciousType = calculateV1Classification(vtReport)  // Fallback        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: Save to MongoDB & Return                                             â”‚
â”‚                                                                               â”‚
â”‚  persistenceManager.save(dataElement, "file_rep")                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
Return to Client:
{
    "maliciousClassification": {"type": "malware", "subTypes": ["trojan"]},
    "productClassification": {...},
    "sha1": "abc123",
    "positives": 45
}</div>

        <h3>Domain/URL Classification Flow</h3>
        <div class="warning-box">
            <strong>âš ï¸ Important:</strong> Domain and URL do NOT use GCS buckets for real-time lookup. They call VirusTotal API directly.
        </div>

        <table>
            <tr>
                <th>Data Type</th>
                <th>Query Source</th>
                <th>GCS Bucket?</th>
            </tr>
            <tr>
                <td><strong>File</strong></td>
                <td>GCS: <code>vt-file-feeder</code> + <code>broccoli-enricher</code></td>
                <td>âœ… Yes</td>
            </tr>
            <tr>
                <td><strong>Domain</strong></td>
                <td>VT API: <code>/vtapi/v2/domain/report</code></td>
                <td>âŒ No</td>
            </tr>
            <tr>
                <td><strong>URL</strong></td>
                <td>VT API: <code>/vtapi/v2/url/report</code></td>
                <td>âŒ No (only time-based archive)</td>
            </tr>
        </table>

        <!-- Section 7: MongoDB Role -->
        <h2 id="mongodb">7. MongoDB Role</h2>
        
        <h3>Three Functions of MongoDB</h3>
        
        <div class="success-box">
            <strong>Function 1: Query Cache</strong><br>
            Avoid re-querying GCS for the same hash. Faster response. Managed by TTL.
        </div>

        <div class="success-box">
            <strong>Function 2: Store Processed Results</strong><br>
            GCS stores raw VT data. MongoDB stores computed classification, product classification, Broccoli ML results, first seen timestamp, etc.
        </div>

        <div class="success-box">
            <strong>Function 3: Background Update Target</strong><br>
            FeedProcessingTask downloads VT feed packages and updates ONLY existing records in MongoDB. Keeps cached data fresh.
        </div>

        <h3>MongoDB vs GCS Content Comparison</h3>
        <table>
            <tr>
                <th>Field</th>
                <th>GCS (vt-file-feeder)</th>
                <th>GCS (broccoli-enricher)</th>
                <th>MongoDB (file_rep)</th>
            </tr>
            <tr>
                <td>Raw VT Report</td>
                <td>âœ… Full report</td>
                <td>âŒ</td>
                <td>âœ… Cached copy</td>
            </tr>
            <tr>
                <td>SHA1/MD5/SHA256</td>
                <td>âœ…</td>
                <td>âŒ</td>
                <td>âœ…</td>
            </tr>
            <tr>
                <td>Scans (70+ engines)</td>
                <td>âœ…</td>
                <td>âŒ</td>
                <td>âœ…</td>
            </tr>
            <tr>
                <td>ML Classification</td>
                <td>âŒ</td>
                <td>âœ…</td>
                <td>âœ…</td>
            </tr>
            <tr>
                <td>Product Classification</td>
                <td>âŒ</td>
                <td>âŒ</td>
                <td>âœ… (computed)</td>
            </tr>
            <tr>
                <td>TTL/Expiration</td>
                <td>âŒ</td>
                <td>âŒ</td>
                <td>âœ…</td>
            </tr>
            <tr>
                <td>First Seen</td>
                <td>âŒ</td>
                <td>âŒ</td>
                <td>âœ…</td>
            </tr>
        </table>

        <!-- Section 8: Comparison -->
        <h2 id="comparison">8. Data Type Comparison</h2>
        
        <h3>Summary Table</h3>
        <table>
            <tr>
                <th>Data Type</th>
                <th>GCS Real-time Lookup</th>
                <th>Direct VT API</th>
                <th>MongoDB Cache</th>
            </tr>
            <tr>
                <td><strong>File</strong></td>
                <td>âœ… vt-file-feeder + broccoli-enricher</td>
                <td>Fallback only</td>
                <td>file_rep</td>
            </tr>
            <tr>
                <td><strong>Domain</strong></td>
                <td>âŒ No bucket</td>
                <td>âœ… Primary source</td>
                <td>domain_classification</td>
            </tr>
            <tr>
                <td><strong>URL</strong></td>
                <td>âŒ Time-based only</td>
                <td>âœ… Primary source</td>
                <td>(varies)</td>
            </tr>
        </table>

        <h3>Why Different Approaches?</h3>
        <table>
            <tr>
                <th>Aspect</th>
                <th>File</th>
                <th>Domain/URL</th>
            </tr>
            <tr>
                <td><strong>Query Volume</strong></td>
                <td>Very high (millions/day)</td>
                <td>Lower</td>
            </tr>
            <tr>
                <td><strong>Index Key</strong></td>
                <td>SHA1 (stable, unique)</td>
                <td>Domain/URL (variable length)</td>
            </tr>
            <tr>
                <td><strong>VT Coverage</strong></td>
                <td>Every scanned file</td>
                <td>On-demand only</td>
            </tr>
            <tr>
                <td><strong>GCS Feasibility</strong></td>
                <td>âœ… Fixed-length hash key</td>
                <td>âš ï¸ URL can be very long</td>
            </tr>
        </table>

        <!-- Section 9: Takeaways -->
        <h2 id="takeaways">9. Key Takeaways</h2>
        
        <h3>Data Flow Summary</h3>
        <div class="diagram">VirusTotal Feed API
       â”‚
       â”‚ Every minute (full data stream)
       â–¼
VT Feeder Suite
       â”‚
       â”œâ”€â”€â–º vt-file-feeder/latest-reports/{sha1}     # Real-time lookup
       â”œâ”€â”€â–º vt-file-feeder-by-date/{date}/{ts}       # Archive
       â”œâ”€â”€â–º broccoli-enricher/latest-reports/{sha1}  # ML classification
       â””â”€â”€â–º vt-url-feeder-by-date/{date}/{ts}        # URL archive
       
       â”‚
       â”‚ On-demand query
       â–¼
Sage Service
       â”‚
       â”œâ”€â”€â–º Check MongoDB cache
       â”œâ”€â”€â–º Query GCS (if cache miss)
       â”œâ”€â”€â–º Process & classify
       â””â”€â”€â–º Save to MongoDB
       
       â”‚
       â–¼
Client Response</div>

        <h3>Key Configuration</h3>
        <pre># cp-keys.properties
virus.total.vt.feeder.enabled=true
virus.total.vt.feeder.report.bucket.name=vt-file-feeder
virus.total.vt.feeder.classification.bucket.name=broccoli-enricher
virus.total.vt.feeder.folder.name=latest-reports</pre>

        <h3>Critical Points</h3>
        <ul>
            <li><strong>Full VT Data</strong>: VT Feed API provides <strong>complete data stream</strong> (every file scanned by VT)</li>
            <li><strong>File vs URL</strong>: File has hash-based GCS lookup; URL only has time-based archive</li>
            <li><strong>MongoDB = Cache</strong>: Not the source of truth; GCS is the source</li>
            <li><strong>Broccoli = ML</strong>: Adds intelligent classification on top of raw VT results</li>
            <li><strong>Two-phase Query</strong>: Raw report (vt-file-feeder) + Classification (broccoli-enricher)</li>
        </ul>

        <hr>
        <p style="color: #5f6368; font-size: 0.9em;">
            <strong>References:</strong><br>
            â€¢ VT Feeder Suite: <code>/Users/tangxin/work/vt-feeder-suite/</code><br>
            â€¢ Sage Service: <code>/Users/tangxin/work/sage-content-provider/services/sage-service/</code><br>
            â€¢ VtFeederClient: <code>integration/src/main/java/.../vtfeeder/VtFeederClient.java</code>
        </p>
    </div>
</body>
</html>
