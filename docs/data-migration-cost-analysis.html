<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Data Migration Network Cost Analysis</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; line-height: 1.6; background: #fff; }
        h1 { color: #172B4D; border-bottom: 3px solid #0052CC; padding-bottom: 12px; }
        h2 { color: #172B4D; margin-top: 30px; border-left: 4px solid #0052CC; padding-left: 12px; }
        h3 { color: #42526E; }
        table { border-collapse: collapse; width: 100%; margin: 15px 0; }
        th, td { border: 1px solid #DFE1E6; padding: 12px 15px; text-align: left; }
        th { background-color: #F4F5F7; color: #172B4D; font-weight: 600; }
        tr:nth-child(even) { background-color: #FAFBFC; }
        code { background-color: #F4F5F7; padding: 2px 6px; border-radius: 3px; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; }
        .info-box { background-color: #DEEBFF; border-left: 4px solid #0052CC; padding: 15px; margin: 15px 0; border-radius: 3px; }
        .warning-box { background-color: #FFFAE6; border-left: 4px solid #FF8B00; padding: 15px; margin: 15px 0; border-radius: 3px; }
        .success-box { background-color: #E3FCEF; border-left: 4px solid #00875A; padding: 15px; margin: 15px 0; border-radius: 3px; }
        .error-box { background-color: #FFEBE6; border-left: 4px solid #DE350B; padding: 15px; margin: 15px 0; border-radius: 3px; }
        .tag { display: inline-block; padding: 3px 10px; border-radius: 3px; font-size: 12px; font-weight: 600; margin-right: 5px; }
        .tag-gcp { background-color: #4285F4; color: white; }
        .tag-oci { background-color: #F80000; color: white; }
        .tag-free { background-color: #00875A; color: white; }
        .tag-cost { background-color: #FF8B00; color: white; }
        .diagram { background: #F4F5F7; border-radius: 8px; padding: 30px; margin: 20px 0; }
        .flow-container { display: flex; flex-direction: column; align-items: center; gap: 0; }
        .flow-box { background: white; border: 2px solid #DFE1E6; border-radius: 8px; padding: 20px; min-width: 300px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .flow-box.gcp { border-color: #4285F4; }
        .flow-box.oci { border-color: #F80000; }
        .flow-box.process { border-color: #00875A; border-style: dashed; }
        .flow-arrow { font-size: 24px; color: #42526E; padding: 5px 0; display: flex; flex-direction: column; align-items: center; }
        .flow-arrow .cost-label { font-size: 12px; background: #FF8B00; color: white; padding: 4px 12px; border-radius: 12px; margin: 8px 0; }
        .flow-arrow .free-label { font-size: 12px; background: #00875A; color: white; padding: 4px 12px; border-radius: 12px; margin: 8px 0; }
        .flow-arrow .data-label { font-size: 11px; color: #6B778C; }
        .oci-zone { background: linear-gradient(135deg, #FFF5F5 0%, #FFE5E5 100%); border: 2px solid #F80000; border-radius: 12px; padding: 25px; margin-top: 10px; }
        .oci-zone-title { color: #F80000; font-weight: 600; margin-bottom: 15px; font-size: 14px; }
        .oci-internal { display: flex; justify-content: center; align-items: center; gap: 30px; }
        .internal-arrow { color: #00875A; font-size: 32px; }
        .cost-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin: 20px 0; }
        .cost-card { background: white; border: 1px solid #DFE1E6; border-radius: 8px; padding: 20px; }
        .cost-card h4 { margin: 0 0 15px 0; color: #172B4D; border-bottom: 2px solid; padding-bottom: 8px; }
        .cost-card.recommended { border-color: #00875A; }
        .cost-card.recommended h4 { border-color: #00875A; }
        .cost-card.expensive h4 { border-color: #DE350B; }
        .cost-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #DFE1E6; }
        .cost-item:last-child { border-bottom: none; }
        .cost-total { font-weight: 700; font-size: 18px; margin-top: 10px; padding-top: 10px; border-top: 2px solid #172B4D; }
        .reduction-flow { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
        .reduction-box { background: white; border: 1px solid #DFE1E6; border-radius: 8px; padding: 15px 20px; text-align: center; min-width: 150px; }
        .reduction-box .size { font-size: 24px; font-weight: 700; color: #0052CC; }
        .reduction-box .label { font-size: 12px; color: #6B778C; margin-top: 5px; }
        .reduction-arrow { font-size: 24px; color: #00875A; }
        .emoji { font-size: 20px; }
    </style>
</head>
<body>

<h1>üöÄ Sage ‚Üí TiDB Data Migration: Network Cost Analysis</h1>

<div class="info-box">
    <strong>Overview:</strong> This document analyzes the network costs for migrating threat intelligence data from Sage MongoDB (GCS dump) to TiDB on OCI. The key insight is that <strong>filtering and compression dramatically reduce transfer costs</strong>.
</div>

<h2>üìä Data Flow Architecture</h2>

<div class="diagram">
    <div class="flow-container">
        <!-- GCS Source -->
        <div class="flow-box gcp">
            <span class="tag tag-gcp">Google Cloud Storage</span>
            <h3 style="margin: 10px 0;">üì¶ Sage MongoDB Dump</h3>
            <code>gs://sage_prod_dump/file_rep.bson</code>
            <p style="margin: 10px 0 0 0; font-size: 28px; font-weight: 700; color: #DE350B;">~10.4 TB</p>
            <p style="margin: 0; color: #6B778C; font-size: 12px;">Raw BSON files (6 shards)</p>
        </div>
        
        <!-- Arrow 1: GCS Egress -->
        <div class="flow-arrow">
            <span>‚¨áÔ∏è</span>
            <span class="cost-label">üí∞ ‚ë† GCS Egress: $0.01-0.12/GB</span>
            <span class="data-label">~10.4 TB (streaming download)</span>
        </div>
        
        <!-- Processing Script -->
        <div class="flow-box process">
            <span class="tag tag-gcp">GCP VM (Recommended)</span>
            <h3 style="margin: 10px 0;">‚öôÔ∏è Processing Script</h3>
            <code>parallel_bson_processor.py</code>
            <div style="text-align: left; margin-top: 15px; font-size: 13px;">
                <p style="margin: 5px 0;">‚úÖ Stream download (no disk storage needed)</p>
                <p style="margin: 5px 0;">‚úÖ Filter: Keep only <code>response_code=1</code></p>
                <p style="margin: 5px 0;">‚úÖ Extract: sha256, sha1, md5, classification</p>
                <p style="margin: 5px 0;">‚úÖ Compress: gzip (~10x reduction)</p>
            </div>
            <p style="margin: 15px 0 0 0; font-size: 14px; color: #00875A; font-weight: 600;">
                üìâ 10.4 TB ‚Üí ~100-300 GB (97% reduction!)
            </p>
        </div>
        
        <!-- Arrow 2: Upload to OCI -->
        <div class="flow-arrow">
            <span>‚¨áÔ∏è</span>
            <span class="cost-label">üí∞ ‚ë° GCP‚ÜíOCI Egress: ~$0.12/GB</span>
            <span class="data-label">~100-300 GB (filtered + compressed)</span>
        </div>
        
        <!-- OCI Zone -->
        <div class="oci-zone">
            <div class="oci-zone-title">‚òÅÔ∏è Oracle Cloud Infrastructure (OCI) - Same VCN</div>
            <div class="oci-internal">
                <div class="flow-box oci" style="min-width: 200px;">
                    <h3 style="margin: 5px 0;">üì• Import Script</h3>
                    <p style="margin: 5px 0; font-size: 12px; color: #6B778C;">OCI VM</p>
                    <div style="text-align: left; font-size: 12px; margin-top: 10px;">
                        <p style="margin: 3px 0;">‚Ä¢ Decompress gzip</p>
                        <p style="margin: 3px 0;">‚Ä¢ Parse NDJSON</p>
                        <p style="margin: 3px 0;">‚Ä¢ UNHEX() conversion</p>
                        <p style="margin: 3px 0;">‚Ä¢ Batch INSERT</p>
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <span class="internal-arrow">‚û°Ô∏è</span>
                    <span class="tag tag-free">‚ë¢ FREE</span>
                    <span style="font-size: 11px; color: #6B778C;">Same VCN</span>
                </div>
                
                <div class="flow-box oci" style="min-width: 200px;">
                    <h3 style="margin: 5px 0;">üóÑÔ∏è TiDB</h3>
                    <p style="margin: 5px 0; font-size: 12px; color: #6B778C;">Serverless / Dedicated</p>
                    <p style="margin: 15px 0 5px 0; font-size: 20px; font-weight: 700; color: #00875A;">~50-100 GB</p>
                    <p style="margin: 0; font-size: 11px; color: #6B778C;">Final storage (binary format)</p>
                </div>
            </div>
        </div>
    </div>
</div>

<h2>üí∞ Cost Comparison</h2>

<div class="cost-summary">
    <!-- Option A: Recommended -->
    <div class="cost-card recommended">
        <h4>‚úÖ Option A: Process on GCP VM (Recommended)</h4>
        <div class="cost-item">
            <span>‚ë† GCS ‚Üí GCP VM (same region)</span>
            <span>10.4 TB √ó $0.01/GB = <strong>~$104</strong></span>
        </div>
        <div class="cost-item">
            <span>‚ë° GCP VM ‚Üí OCI (compressed)</span>
            <span>200 GB √ó $0.12/GB = <strong>~$24</strong></span>
        </div>
        <div class="cost-item">
            <span>‚ë¢ OCI Internal</span>
            <span class="tag tag-free">FREE</span>
        </div>
        <div class="cost-total" style="color: #00875A;">
            Total: ~$128
        </div>
    </div>
    
    <!-- Option B: Local -->
    <div class="cost-card expensive">
        <h4>‚ùå Option B: Process on Local Machine</h4>
        <div class="cost-item">
            <span>‚ë† GCS ‚Üí Internet</span>
            <span>10.4 TB √ó $0.12/GB = <strong style="color: #DE350B;">~$1,248</strong></span>
        </div>
        <div class="cost-item">
            <span>‚ë° Local ‚Üí OCI (upload)</span>
            <span class="tag tag-free">FREE</span>
        </div>
        <div class="cost-item">
            <span>‚ë¢ OCI Internal</span>
            <span class="tag tag-free">FREE</span>
        </div>
        <div class="cost-total" style="color: #DE350B;">
            Total: ~$1,248 ‚ùå
        </div>
    </div>
</div>

<div class="success-box">
    <strong>üí° Key Insight:</strong> By processing on a GCP VM in the same region as GCS, we pay only $0.01/GB for the large raw data download. The expensive cross-cloud transfer only applies to the small, filtered output (~97% smaller).
</div>

<h2>üìâ Data Reduction Breakdown</h2>

<div class="reduction-flow">
    <div class="reduction-box">
        <div class="size">10.4 TB</div>
        <div class="label">Raw BSON<br/>(GCS dump)</div>
    </div>
    
    <div class="reduction-arrow">
        <div>‚û°Ô∏è</div>
        <div style="font-size: 10px;">Filter<br/>response_code=1</div>
    </div>
    
    <div class="reduction-box">
        <div class="size">~2-3 TB</div>
        <div class="label">After filtering<br/>(~70-80% unknown)</div>
    </div>
    
    <div class="reduction-arrow">
        <div>‚û°Ô∏è</div>
        <div style="font-size: 10px;">Extract<br/>minimal fields</div>
    </div>
    
    <div class="reduction-box">
        <div class="size">~500 GB</div>
        <div class="label">Minimal JSON<br/>(hashes + classification)</div>
    </div>
    
    <div class="reduction-arrow">
        <div>‚û°Ô∏è</div>
        <div style="font-size: 10px;">gzip<br/>compress</div>
    </div>
    
    <div class="reduction-box" style="border-color: #00875A;">
        <div class="size" style="color: #00875A;">~100-300 GB</div>
        <div class="label">Final transfer<br/>(97% reduction!)</div>
    </div>
</div>

<h2>üìã Data Sources Summary</h2>

<table>
    <tr>
        <th>Phase</th>
        <th>Source Collection</th>
        <th>Target Table</th>
        <th>Raw Size</th>
        <th>After Filter</th>
    </tr>
    <tr>
        <td><strong>Phase 1</strong></td>
        <td><code>file_rep</code> (VT File Reports)</td>
        <td><code>ioc_file_hashes</code></td>
        <td>~5.7 TB</td>
        <td>~100 GB</td>
    </tr>
    <tr>
        <td><strong>Phase 1</strong></td>
        <td><code>TOKENS</code> (SHA1 type)</td>
        <td><code>ioc_file_hashes</code></td>
        <td>~500 MB</td>
        <td>~50 MB</td>
    </tr>
    <tr>
        <td><strong>Phase 2</strong></td>
        <td><code>domain_classification</code></td>
        <td><code>ioc_domains</code></td>
        <td>~480 GB</td>
        <td>~20 GB</td>
    </tr>
    <tr>
        <td><strong>Phase 2</strong></td>
        <td><code>TOKENS</code> (Domain/IP types)</td>
        <td><code>ioc_domains</code> / <code>ioc_ips</code></td>
        <td>~500 MB</td>
        <td>~50 MB</td>
    </tr>
    <tr>
        <td><strong>Phase 2</strong></td>
        <td><code>SINKHOLE_IDENTIFIERS</code></td>
        <td><code>ioc_ips</code></td>
        <td>~10 MB</td>
        <td>~1 MB</td>
    </tr>
    <tr>
        <td><strong>Phase 3</strong></td>
        <td><code>FILE_EXTENSION_CLASSIFICATION</code></td>
        <td><code>file_extension_classification</code></td>
        <td>~100 KB</td>
        <td>~10 KB</td>
    </tr>
</table>

<h2>üîß Implementation Steps</h2>

<table>
    <tr>
        <th>Step</th>
        <th>Action</th>
        <th>Location</th>
        <th>Output</th>
    </tr>
    <tr>
        <td>1</td>
        <td>Provision GCP VM (e2-standard-4, same region as GCS bucket)</td>
        <td>GCP Console</td>
        <td>VM ready</td>
    </tr>
    <tr>
        <td>2</td>
        <td>Run <code>parallel_bson_processor.py</code> with streaming</td>
        <td>GCP VM</td>
        <td><code>*.ndjson.gz</code> files</td>
    </tr>
    <tr>
        <td>3</td>
        <td>Upload compressed files to OCI Object Storage</td>
        <td>GCP VM ‚Üí OCI</td>
        <td>Files in OCI bucket</td>
    </tr>
    <tr>
        <td>4</td>
        <td>Run import script (NDJSON ‚Üí TiDB)</td>
        <td>OCI VM</td>
        <td>Data in TiDB</td>
    </tr>
    <tr>
        <td>5</td>
        <td>Verify data integrity and counts</td>
        <td>TiDB</td>
        <td>Migration complete ‚úÖ</td>
    </tr>
</table>

<div class="warning-box">
    <strong>‚ö†Ô∏è Notes:</strong>
    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
        <li>GCS egress pricing varies by destination region - use same-region VM for lowest cost</li>
        <li>Consider using GCP Cloud Interconnect or Dedicated Interconnect for very large transfers</li>
        <li>The <code>parallel_bson_processor.py</code> script supports streaming to avoid disk space requirements</li>
        <li>TiDB Lightning can be used for faster bulk imports if needed</li>
    </ul>
</div>

<hr style="margin: 40px 0; border: none; border-top: 1px solid #DFE1E6;">
<p style="color: #6B778C; font-size: 12px;">
    Document generated: January 2026 | Phoenix Team | Data Migration Planning
</p>

</body>
</html>
